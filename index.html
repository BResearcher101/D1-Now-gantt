<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Recruitment and Onboarding Timeline</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Trial Recruitment and Onboarding Timeline</h1>

    <div id="inputs">
        <h3>Adjust Start Dates</h3>
        <form id="date-form">
            <div>
                <label for="centre1">Centre 1:</label>
                <input type="date" id="centre1" name="centre1" value="2025-05-01">
            </div>
            <!-- Additional centres here -->
            <button type="button" id="update-timeline">Update Timeline</button>
        </form>
    </div>

    <div id="timeline"></div>

    <script>
        const taskColours = {
            "Ethics Approval": "#1f77b4",
            "Onboarding": "#ff7f0e",
            "Participant Screening": "#2ca02c",
            "Legal Approval": "#d62728",
            "Recruitment": "#9467bd",
            "Baseline Data Collection": "#8c564b",
            "Randomisation": "#e377c2",
            "Support Worker Integration": "#7f7f7f",
            "Interval": "#bcbd22",
            "Clinic Appointment 1": "#17becf",
            "Clinic Appointment 2": "#d62728",
            "Clinic Appointment 3": "#9467bd",
        };

        const clinicAppointmentMarker = {
            size: 12, // Larger marker size for Clinic Appointments
            symbol: "diamond", // Distinctive shape for clarity
        };

        function generateTimeline(data) {
            const tasks = [];

            data.forEach(({ Centre, EthicsApprovalDate }) => {
                const ethicsApproval = new Date(EthicsApprovalDate);
                const onboardingEnd = new Date(ethicsApproval);
                onboardingEnd.setDate(onboardingEnd.getDate() + 14);

                const screeningEnd = new Date(onboardingEnd);
                screeningEnd.setDate(screeningEnd.getDate() + 14);

                const legalApprovalEnd = new Date(screeningEnd);
                legalApprovalEnd.setDate(legalApprovalEnd.getDate() + 7);

                const recruitmentEnd = new Date(legalApprovalEnd);
                recruitmentEnd.setDate(recruitmentEnd.getDate() + 7);

                const baselineStart = new Date(recruitmentEnd);

                const randomisationEnd = new Date(baselineStart);
                randomisationEnd.setDate(randomisationEnd.getDate() + 7);

                const supportWorkerEnd = new Date(baselineStart);
                supportWorkerEnd.setMonth(supportWorkerEnd.getMonth() + 4);

                const clinic1Start = new Date(baselineStart);
                clinic1Start.setMonth(clinic1Start.getMonth() + 4);

                const clinic2Start = new Date(clinic1Start);
                clinic2Start.setMonth(clinic2Start.getMonth() + 4);

                const clinic3Start = new Date(clinic2Start);
                clinic3Start.setMonth(clinic3Start.getMonth() + 4);

                tasks.push(
                    { Task: "Ethics Approval", Centre, Start: ethicsApproval, End: onboardingEnd },
                    { Task: "Onboarding", Centre, Start: onboardingEnd, End: screeningEnd },
                    { Task: "Participant Screening", Centre, Start: screeningEnd, End: legalApprovalEnd },
                    { Task: "Legal Approval", Centre, Start: legalApprovalEnd, End: recruitmentEnd },
                    { Task: "Recruitment", Centre, Start: recruitmentEnd, End: baselineStart },
                    { Task: "Baseline Data Collection", Centre, Start: baselineStart, End: randomisationEnd },
                    { Task: "Randomisation", Centre, Start: randomisationEnd, End: clinic1Start },
                    { Task: "Support Worker Integration", Centre, Start: randomisationEnd, End: supportWorkerEnd },
                    { Task: "Interval", Centre, Start: randomisationEnd, End: clinic1Start },
                    {
                        Task: "Clinic Appointment 1",
                        Centre,
                        Start: clinic1Start,
                        End: clinic2Start,
                        Marker: clinicAppointmentMarker,
                    },
                    { Task: "Interval", Centre, Start: clinic1Start, End: clinic2Start },
                    {
                        Task: "Clinic Appointment 2",
                        Centre,
                        Start: clinic2Start,
                        End: clinic3Start,
                        Marker: clinicAppointmentMarker,
                    },
                    { Task: "Interval", Centre, Start: clinic2Start, End: clinic3Start },
                    {
                        Task: "Clinic Appointment 3",
                        Centre,
                        Start: clinic3Start,
                        End: new Date(clinic3Start),
                        Marker: clinicAppointmentMarker,
                    }
                );
            });

            const plotData = tasks.map(task => ({
                x: [task.Start.toISOString().split("T")[0], task.End.toISOString().split("T")[0]],
                y: [task.Centre, task.Centre],
                type: "scatter",
                mode: "lines+markers",
                line: { width: 10, color: taskColours[task.Task] },
                marker: task.Marker || { size: 6 }, // Default size for non-clinic tasks
                name: task.Task,
                hoverinfo: "name+x",
            }));

            const layout = {
                title: "Trial Recruitment and Onboarding Timeline",
                xaxis: {
                    title: "Date",
                    type: "date",
                    tickformat: "%b-%Y",
                },
                yaxis: {
                    title: "Centres",
                    automargin: true,
                },
                margin: {
                    l: 150,
                },
            };

            Plotly.newPlot("timeline", plotData, layout);
        }

        const initialData = [
            { Centre: "Centre 1", EthicsApprovalDate: "2025-05-01" },
            { Centre: "Centre 2", EthicsApprovalDate: "2025-06-01" },
            { Centre: "Centre 3", EthicsApprovalDate: "2025-07-01" },
        ];

        generateTimeline(initialData);

        document.getElementById("update-timeline").addEventListener("click", () => {
            const formData = new FormData(document.getElementById("date-form"));
            const updatedData = Array.from(formData.keys()).map((key, index) => ({
                Centre: `Centre ${index + 1}`,
                EthicsApprovalDate: formData.get(key),
            }));
            generateTimeline(updatedData);
        });
    </script>
</body>
</html>
