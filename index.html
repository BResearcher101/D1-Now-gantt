<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Recruitment and Onboarding Timeline</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Trial Recruitment and Onboarding Timeline</h1>

    <div id="inputs">
        <h3>Adjust Start Dates</h3>
        <form id="date-form">
            <div>
                <label for="centre1">Centre 1:</label>
                <input type="date" id="centre1" name="centre1" value="2025-05-01">
            </div>
            <!-- Add inputs for all centres -->
            <button type="button" id="update-timeline">Update Timeline</button>
        </form>
    </div>

    <div id="timeline"></div>

    <script>
        const taskColours = {
            "Ethics Approval": "#1f77b4",
            "Onboarding": "#ff7f0e",
            "Participant Screening": "#2ca02c",
            "Legal Approval": "#d62728",
            "Recruitment": "#9467bd",
            "Baseline Data Collection": "#8c564b",
            "Randomisation": "#e377c2",
            "Support Worker Integration": "#7f7f7f",
            "Interval 1": "#bcbd22", // Baseline → Clinic 1
            "Clinic Appointment 1": "#17becf",
            "Interval 2": "#bcbd22", // Clinic 1 → Clinic 2
            "Clinic Appointment 2": "#d62728",
            "Interval 3": "#bcbd22", // Clinic 2 → Clinic 3
            "Clinic Appointment 3": "#9467bd",
        };

        function generateTimeline(data) {
            const tasks = [];

            data.forEach(({ Centre, EthicsApprovalDate }) => {
                const ethicsApproval = new Date(EthicsApprovalDate);
                const onboardingEnd = new Date(ethicsApproval);
                onboardingEnd.setDate(onboardingEnd.getDate() + 14); // 2 weeks onboarding

                const screeningEnd = new Date(onboardingEnd);
                screeningEnd.setDate(screeningEnd.getDate() + 14); // 2 weeks participant screening

                const legalApprovalEnd = new Date(screeningEnd);
                legalApprovalEnd.setDate(legalApprovalEnd.getDate() + 7); // 1 week legal approval

                const recruitmentEnd = new Date(legalApprovalEnd);
                recruitmentEnd.setDate(recruitmentEnd.getDate() + 7); // 1 week recruitment

                const baselineStart = new Date(recruitmentEnd);

                const randomisationEnd = new Date(baselineStart);
                randomisationEnd.setDate(randomisationEnd.getDate() + 7); // 1 week randomisation

                const interval1End = new Date(baselineStart);
                interval1End.setMonth(interval1End.getMonth() + 4); // 4 months Baseline → Clinic 1

                const clinic1Date = new Date(interval1End);

                const interval2End = new Date(clinic1Date);
                interval2End.setMonth(interval2End.getMonth() + 4); // 4 months Clinic 1 → Clinic 2

                const clinic2Date = new Date(interval2End);

                const interval3End = new Date(clinic2Date);
                interval3End.setMonth(interval3End.getMonth() + 4); // 4 months Clinic 2 → Clinic 3

                const clinic3Date = new Date(interval3End);

                tasks.push(
                    { Task: "Ethics Approval", Centre, Start: ethicsApproval, End: onboardingEnd },
                    { Task: "Onboarding", Centre, Start: onboardingEnd, End: screeningEnd },
                    { Task: "Participant Screening", Centre, Start: screeningEnd, End: legalApprovalEnd },
                    { Task: "Legal Approval", Centre, Start: legalApprovalEnd, End: recruitmentEnd },
                    { Task: "Recruitment", Centre, Start: recruitmentEnd, End: baselineStart },
                    { Task: "Baseline Data Collection", Centre, Start: baselineStart, End: randomisationEnd },
                    { Task: "Randomisation", Centre, Start: randomisationEnd, End: interval1End },
                    { Task: "Interval 1", Centre, Start: randomisationEnd, End: interval1End },
                    { Task: "Clinic Appointment 1", Centre, Start: clinic1Date, End: clinic1Date },
                    { Task: "Interval 2", Centre, Start: clinic1Date, End: interval2End },
                    { Task: "Clinic Appointment 2", Centre, Start: clinic2Date, End: clinic2Date },
                    { Task: "Interval 3", Centre, Start: clinic2Date, End: interval3End },
                    { Task: "Clinic Appointment 3", Centre, Start: clinic3Date, End: clinic3Date }
                );
            });

            const plotData = tasks.map(task => ({
                x: [task.Start.toISOString().split("T")[0], task.End.toISOString().split("T")[0]],
                y: [task.Centre, task.Centre],
                type: "scatter",
                mode: "lines+markers",
                line: { width: 10, color: taskColours[task.Task] },
                name: task.Task,
                hoverinfo: "name+x",
            }));

            const layout = {
                title: "Trial Recruitment and Onboarding Timeline",
                xaxis: {
                    title: "Date",
                    type: "date",
                    tickformat: "%b-%Y",
                },
                yaxis: {
                    title: "Centres",
                    automargin: true,
                },
                margin: {
                    l: 150, // Space for long centre/task names
                },
            };

            Plotly.newPlot("timeline", plotData, layout);
        }

        const initialData = [
            { Centre: "Centre 1", EthicsApprovalDate: "2025-05-01" },
            { Centre: "Centre 2", EthicsApprovalDate: "2025-06-01" },
            { Centre: "Centre 3", EthicsApprovalDate: "2025-07-01" },
            { Centre: "Centre 4", EthicsApprovalDate: "2025-08-01" },
            { Centre: "Centre 5", EthicsApprovalDate: "2025-09-01" },
            { Centre: "Centre 6", EthicsApprovalDate: "2025-10-01" },
            { Centre: "Centre 7", EthicsApprovalDate: "2025-11-01" },
            { Centre: "Centre 8", EthicsApprovalDate: "2025-12-01" },
            { Centre: "Centre 9", EthicsApprovalDate: "2026-01-01" },
            { Centre: "Centre 10", EthicsApprovalDate: "2026-03-01" },
            { Centre: "Centre 11", EthicsApprovalDate: "2026-05-01" },
            { Centre: "Centre 12", EthicsApprovalDate: "2026-07-01" },
        ];

        generateTimeline(initialData);

        document.getElementById("update-timeline").addEventListener("click", () => {
            const formData = new FormData(document.getElementById("date-form"));
            const updatedData = Array.from(formData.keys()).map((key, index) => ({
                Centre: `Centre ${index + 1}`,
                EthicsApprovalDate: formData.get(key),
            }));
            generateTimeline(updatedData);
        });
    </script>
</body>
</html>
