<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Trial Timeline</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav>
        <a href="index.html">Home</a> |
        <a href="new_page.html">Detailed Timeline</a>
    </nav>

    <h1>Detailed Trial Timeline</h1>
    <div id="timeline"></div>

    <script>
        // Define end date of the project
        const projectEndDate = new Date("2028-05-31");

        // Define colours for tasks
        const taskColours = {
            "Pre-Preparation": "#1f77b4",
            "Quantitative Survey": "#ff7f0e",
            "Qualitative Data Collection": "#2ca02c",
            "Effectiveness Evaluation": "#d62728",
            "Economic Analysis Reporting": "#9467bd",
            "Process Evaluation & Qualitative Study": "#8c564b",
            "SWAT Analysis": "#e377c2",
            "Report Writing & Publication": "#7f7f7f",
            "Knowledge Translation & Dissemination": "#bcbd22"
        };

        // Example data from the first page (Onboarding dates for 3 centres)
        const centresData = [
            { Centre: "Centre 1", OnboardingDate: "2025-05-01" },
            { Centre: "Centre 2", OnboardingDate: "2025-06-01" },
            { Centre: "Centre 3", OnboardingDate: "2025-07-01" },
            // Add more centres dynamically from the first page
        ];

        // Generate tasks based on the onboarding dates
        const tasks = [];
        centresData.forEach(({ Centre, OnboardingDate }) => {
            const onboardingDate = new Date(OnboardingDate);
            const prePrepEnd = new Date(onboardingDate);
            prePrepEnd.setMonth(prePrepEnd.getMonth() + 2); // 2 months for pre-preparation

            const clinic3Date = new Date(prePrepEnd);
            clinic3Date.setMonth(clinic3Date.getMonth() + 12); // 12 months for clinic appointments

            const quantSurveyEnd = new Date(clinic3Date);
            quantSurveyEnd.setDate(quantSurveyEnd.getDate() + 10); // 10 days for quant survey

            const qualDataEnd = new Date(clinic3Date);
            qualDataEnd.setMonth(qualDataEnd.getMonth() + 3); // 3 months for qualitative data collection

            // Add tasks for each centre
            tasks.push(
                { Task: "Pre-Preparation", Centre, Start: onboardingDate, End: prePrepEnd },
                { Task: "Quantitative Survey", Centre, Start: clinic3Date, End: quantSurveyEnd },
                { Task: "Qualitative Data Collection", Centre, Start: clinic3Date, End: qualDataEnd }
            );
        });

        // Calculate start of the global analysis tasks
        const allFollowUpsComplete = tasks
            .filter(task => task.Task === "Qualitative Data Collection")
            .reduce((latest, task) => new Date(Math.max(latest, task.End)), new Date(0));

        // Add global analysis tasks
        const effectivenessEvalEnd = new Date(allFollowUpsComplete);
        effectivenessEvalEnd.setMonth(effectivenessEvalEnd.getMonth() + 4); // 4 months for effectiveness evaluation

        const reportWritingStart = effectivenessEvalEnd;

        tasks.push(
            { Task: "Effectiveness Evaluation", Centre: "Global", Start: allFollowUpsComplete, End: effectivenessEvalEnd },
            { Task: "Process Evaluation & Qualitative Study", Centre: "Global", Start: allFollowUpsComplete, End: projectEndDate },
            { Task: "Economic Analysis Reporting", Centre: "Global", Start: allFollowUpsComplete, End: effectivenessEvalEnd },
            { Task: "SWAT Analysis", Centre: "Global", Start: allFollowUpsComplete, End: projectEndDate },
            { Task: "Report Writing & Publication", Centre: "Global", Start: reportWritingStart, End: projectEndDate },
            { Task: "Knowledge Translation & Dissemination", Centre: "Global", Start: reportWritingStart, End: projectEndDate }
        );

        // Prepare data for Plotly
        const plotData = tasks.map(task => ({
            x: [task.Start.toISOString().split("T")[0], task.End.toISOString().split("T")[0]],
            y: [task.Centre, task.Centre],
            type: "scatter",
            mode: "lines+markers",
            line: { width: 10, color: taskColours[task.Task] },
            name: task.Task,
            hoverinfo: "name+x"
        }));

        // Define layout
        const layout = {
            title: "Detailed Trial Timeline",
            xaxis: {
                title: "Date",
                type: "date",
                tickformat: "%b-%Y",
            },
            yaxis: {
                title: "Centres",
                automargin: true,
            },
            margin: {
                l: 200, // Space for longer task names
            },
        };

        // Render the Plotly chart
        Plotly.newPlot("timeline", plotData, layout);
    </script>
</body>
</html>
